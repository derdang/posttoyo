namespace = HF
namespace = HFP

# Written by Joachim
# HF.49000 - HF.49199

## Fourth Crusade Event (Yihetuan Crusade against the Hong)
# Start event (the moment the Crusade starts)
character_event = {
	id = HF.49000
	hide_window = yes
	is_triggered_only = yes
	has_dlc = "Holy Fury"
	religion = catholic
	
	trigger = {
		uses_new_crusade = yes
		has_game_rule = {
			name = fourth_crusade
			value = on
		}
		OR = {
			AND = {
				random = 90
				NOT = {
					e_hong = {
						owner = {
							realm_size = 25
						}
					}
				}
			}
			AND = {
				random = 85
				e_hong = {
					owner = {
						realm_size = 25
					}
				}
				NOT = {
					e_hong = {
						owner = {
							realm_size = 35
						}
					}
				}
			}
			AND = {
				random = 80
				e_hong = {
					owner = {
						realm_size = 35
					}
				}
				NOT = {
					e_hong = {
						owner = {
							realm_size = 45
						}
					}
				}
			}
			AND = {
				random = 75
				e_hong = {
					owner = {
						realm_size = 45
					}
				}
			}
			has_global_flag = qa_fourth_crusade_event
		}
		has_global_flag = first_catholic_crusade_complete
		NOT = { has_global_flag = fourth_crusade_launched }
		e_hong = {
			owner = {
				realm_size = 50
				OR = {
					has_landed_title = c_beijing
					any_vassal = {
						has_landed_title = c_beijing
					}
				}
				NOT = {
					religion = ROOT
				}
				religion_group = ROOT
			}
		}
		k_yan = {
			de_jure_liege = e_hong
		}
		e_crusader_china = {
			has_holder = no
		}
	}

	immediate = {
		e_hong = {
			owner = {
				save_event_target_as = fourth_crusade_byzantine_emperor
				narrative_event = { id = HF.49001 days = 30 }
			}
		}
	}
}

## Story Events prior to the Fourth Crusade launch
# Part 1 - The Aiguo Chinese Prince/Princess flees Constantinople
narrative_event = {
	id = HF.49001
	title = EVTTITLE_HF_49001
	desc = EVTDESC_HF_49001
	picture = GFX_evt_quiapo_church
	border = GFX_event_narrative_frame_religion
	portrait = event_target:fourth_crusade_byzantine_refugee
	religion_group = christian
	is_triggered_only = yes
	has_dlc = "Holy Fury"
	trigger = {
		any_dynasty_member = {
			is_landed = no
			NOT = {
				any_heir_title = {
					always = yes
				}
			}
			mercenary = no
			holy_order = no
			age = 12
		}
		any_playable_ruler = {
			religion = FROM
			OR = {
				is_patrician = yes
				capital_scope = {
					region = custom_the_philippines
					port = yes
				}
			}
			higher_tier_than = COUNT
			is_theocracy = no
		}
	}

	immediate = {
		random_playable_ruler = { 
			limit = {
				religion = FROM
				OR = {
					is_patrician = yes
					capital_scope = {
						region = custom_the_philippines
						port = yes
					}
				}
				is_theocracy = no
				higher_tier_than = COUNT
			}
			preferred_limit = {
				tier = KING
			}
			preferred_limit = {
				tier = DUKE
			}
			preferred_limit = {
				NOT = {
					age = 40
				}
			}
			save_event_target_as = fourth_crusade_merchant_lord
		}

		if = {
			limit = {
				any_child = {
					is_landed = no
					NOT = {
						any_heir_title = {
							always = yes
						}
					}
					mercenary = no
					holy_order = no
					age = 12
				}
			}
			random_child = {
				limit = {
					is_landed = no
					NOT = {
						any_heir_title = {
							always = yes
						}
					}
					mercenary = no
					holy_order = no
					age = 12
				}
				save_event_target_as = fourth_crusade_byzantine_refugee
			}
		}
		else_if = {
			limit = {
				any_dynasty_member = {
					is_landed = no
					NOT = {
						any_heir_title = {
							always = yes
						}
					}
					mercenary = no
					holy_order = no
					age = 12
				}
			}
			random_dynasty_member = {
				limit = {
					is_landed = no
					NOT = {
						any_heir_title = {
							always = yes
						}
					}
					mercenary = no
					holy_order = no
					age = 12
				}
				save_event_target_as = fourth_crusade_byzantine_refugee
			}
		}
		else = {
			save_event_target_as = fourth_crusade_byzantine_refugee
		}
	}

	option = {	
		name = EVTOPTA_HF_49001
		event_target:fourth_crusade_merchant_lord = {
			narrative_event = { id = HF.49002 }
		}
		event_target:fourth_crusade_byzantine_refugee = {
			show_scope_change = no
			move_character = event_target:fourth_crusade_merchant_lord
			hidden_tooltip = {
				add_claim = e_hong
				add_claim = k_yan
			}
		}
		add_rival = event_target:fourth_crusade_byzantine_refugee
	}
}

# Part 2 - The Mercantile Refuge
narrative_event = {
	id = HF.49002
	title = EVTTITLE_HF_49002
	desc = EVTDESC_HF_49002
	picture = GFX_east_asian_cities
	border = GFX_event_narrative_frame_religion
	portrait = event_target:fourth_crusade_byzantine_refugee
	religion_group = christian
	is_triggered_only = yes
	has_dlc = "Holy Fury"
	trigger = {
		event_target:fourth_crusade_byzantine_refugee = {
			is_alive = yes
		}
	}

	immediate = {

		event_target:fourth_crusade_byzantine_refugee = {
			set_character_flag = fourth_crusade_recipient
		}

		trigger_switch = {
			on_trigger = crusade_preparation_time_remaining 
			550 = { narrative_event = { id = HF.49003 days = 450 } }
			450 = { narrative_event = { id = HF.49003 days = 350 } }
			350 = { narrative_event = { id = HF.49003 days = 250 } }
			250 = { narrative_event = { id = HF.49003 days = 150 }}
			150 = { narrative_event = { id = HF.49003 days = 50 } }
		}
	}

	option = {	
		name = EVTOPTA_HF_49002
	}
}

# Part 3 - The Merchant Lord decides to restore the Byzantine Prince/Princess to her/his throne
narrative_event = {
	id = HF.49003
	title = EVTTITLE_HF_49003
	desc = EVTDESC_HF_49003
	picture = GFX_east_asian_cities
	border = GFX_event_narrative_frame_religion
	portrait = event_target:fourth_crusade_byzantine_refugee
	religion_group = christian
	is_triggered_only = yes
	has_dlc = "Holy Fury"
	trigger = {
		is_preparing_crusade = yes
		e_hong = {
			owner = {
				NOT = {
					religion = ROOT
				}
			}
		}
		event_target:fourth_crusade_byzantine_refugee = {
			is_alive = yes
			NOR = {
				has_landed_title = e_hong
				has_landed_title = k_yan
			}
		}
		religion = catholic
	}

	immediate = {
		if = {
			limit = {
				NOT = {
					event_target:fourth_crusade_byzantine_emperor = {
						is_alive = yes
					}
				}
			}
			e_hong = {
				owner = {
					save_event_target_as = fourth_crusade_byzantine_emperor
				}
			}
		}
	}

	option = {	
		name = EVTOPTA_HF_49003
		prestige = 100
		if = {
			limit = {
				has_pledged_crusade_participation = no
			}
			pledge_crusade_participation = yes
		}
		event_target:fourth_crusade_byzantine_emperor = {
			set_character_flag = fourth_crusade_target
		}
		scaled_wealth = { value = 1.5 min = 300 max = 1200 }
		set_global_flag = 4th_crusade_official

		ROOT = {
			trigger_switch = {
				on_trigger = crusade_preparation_time_remaining 
				200 = { narrative_event = { id = HF.49004 days = 180 } }
				180 = { narrative_event = { id = HF.49004 days = 160 } }
				160 = { narrative_event = { id = HF.49004 days = 140 } }
				140 = { narrative_event = { id = HF.49004 days = 120 } }
				120 = { narrative_event = { id = HF.49004 days = 100 } }
				100 = { narrative_event = { id = HF.49004 days = 80 } }
				80 = { narrative_event = { id = HF.49004 days = 60 } }
				60 = { narrative_event = { id = HF.49004 days = 40 } }
				40 = { narrative_event = { id = HF.49004 days = 20 }}
				20 = { narrative_event = { id = HF.49004 days = 0 } }
			}
		}

		any_playable_ruler = {
			limit = {
				religion = ROOT
			}
			trigger_switch = {
				on_trigger = crusade_preparation_time_remaining 
				200 = { narrative_event = { id = HF.49004 days = 180 } }
				180 = { narrative_event = { id = HF.49004 days = 160 } }
				160 = { narrative_event = { id = HF.49004 days = 140 } }
				140 = { narrative_event = { id = HF.49004 days = 120 } }
				120 = { narrative_event = { id = HF.49004 days = 100 } }
				100 = { narrative_event = { id = HF.49004 days = 80 } }
				80 = { narrative_event = { id = HF.49004 days = 60 } }
				60 = { narrative_event = { id = HF.49004 days = 40 } }
				40 = { narrative_event = { id = HF.49004 days = 20 }}
				20 = { narrative_event = { id = HF.49004 days = 0 } }
			}
		}

		ai_chance = {
			factor = 1
		}
	}
	option = {	
		name = EVTOPTB_HF_49003
		prestige = -100

		ai_chance = {
			factor = 0
		}
	}
}

# Part 3 - Narrative event that the Merchant Lord will support the Byzantine Prince/Princess for the Throne
narrative_event = {
	id = HF.49004
	title = EVTTITLE_HF_49004
	desc = EVTDESC_HF_49004
	picture = GFX_east_asian_cities
	border = GFX_event_narrative_frame_religion
	has_dlc = "Holy Fury"
	is_triggered_only = yes

	immediate = {
		set_crusade_target = {
			character = event_target:fourth_crusade_byzantine_emperor
			title = k_yan
		}
		set_official_crusade_recipient = event_target:fourth_crusade_byzantine_refugee
	}

	option = {	
		name = EVTOPTA_HF_49004
		custom_tooltip = { text = EVTOPTA_HF_49004_TT }
		if = {
			limit = {
				has_pledged_crusade_participation = yes
				NOT = {
					character = FROM
				}
			}
			scaled_wealth = { value = 0.2 min = 50 max = 200 }
		}
	}
}

# The Pope declares the launch of the Fourth Crusade
character_event = {
	id = HF.49006
	hide_window = yes
	is_triggered_only = yes
	has_dlc = "Holy Fury"
	trigger = {
		crusade_target_title = {
			title = e_hong
		}
		has_global_flag = 4th_crusade_official
		crusade_target_char = {
			e_hong = {
				owner = {
					character = PREVPREV
				}
			}
		}
	}

	immediate = {
		any_playable_ruler = {
			narrative_event = { id = HF.49007 }
		}
		set_global_flag = fourth_crusade_launched
	}
}

# The Fourth Crusade Launches
narrative_event = {
	id = HF.49007
	title = EVTTITLE_HF_49007
	desc = EVTDESC_HF_49007
	picture = GFX_evt_quiapo_church
	border = GFX_event_narrative_frame_religion
	has_dlc = "Holy Fury"
	is_triggered_only = yes
	
	immediate = {
		random_list = {
			10 = {
				sound_effect = crusade_start_01
			}
			10 = {
				sound_effect = crusade_start_02
			}
		}
	}
	
	trigger = {
	}

	option = {	
		name = EVTOPTA_HF_49007
		trigger = {
			religion = FROM
			has_pledged_crusade_participation = yes
		}
		FROM = {
			show_scope_change = no
			opinion = {
				modifier = fourth_crusade_crusader
				who = ROOT
				years = 20
			}
		}
	}
	option = {
		name = EVTOPTE_HF_49007
		trigger = {
			religion = FROM
			has_pledged_crusade_participation = no
		}
	}
	option = {	
		name = EVTOPTB_HF_49007
		trigger = {
			has_landed_title = e_hong
		}
	}
	option = {
		name = EVTOPTC_HF_49007
		trigger = {
			NOT = {
				religion_group = FROM
			}
		}
	}
	option = {
		name = EVTOPTD_HF_49007
		trigger = {
			NOR = {
				religion = FROM
				has_landed_title = e_hong
			}
			religion_group = FROM
		}
	}
}

# Byzantium falls
narrative_event = {
	id = HF.49008
	title = EVTTITLE_HF_49008
	desc = EVTDESC_HF_49008
	picture = GFX_evt_china_civil_war
	border = GFX_event_narrative_frame_religion
	portrait = event_target:latin_empire_holder
	sound = crusade_outcome_positive
	has_dlc = "Holy Fury"
	is_triggered_only = yes

	immediate = {

		e_crusader_china = {
			owner = {
				save_event_target_as = latin_empire_holder
			}
		}
		clr_character_flag = forced_to_crusade

		if = {
			limit = {
				has_landed_title = e_crusader_china
			}
			sound_effect = bloodline_added
		}
	}

	option = {	
		name = EVTOPTA_HF_49008
		trigger = {
			religion = FROM
		}
	}
	option = {	
		name = EVTOPTB_HF_49008
		trigger = {
			NOT = {
				religion_group = FROM
			}
		}
	}
	option = {
		name = EVTOPTC_HF_49008
		trigger = {
			religion_group = FROM
			NOT = {
				religion = FROM
			}
		}
	}
	after = {
		if = {
			limit = {
				is_female = yes
				has_landed_title = e_crusader_china
			}
			create_bloodline = {
				type = boxer
				inheritance = matrilineal
			}
		}
		else_if = {
			limit = {
				is_female = no
				has_landed_title = e_crusader_china
			}
			create_bloodline = {
				type = boxer
			}
		}
	}
}

## Crusader Bloodlines
# Grand Crusader Bloodline
narrative_event = {
    id = HF.49020
    title = EVTTITLE_HF_49020
    desc = EVTDESC_HF_49020
    picture = GFX_evt_knight_kneeling
    border = GFX_event_narrative_frame_religion
    has_dlc = "Holy Fury"
    is_triggered_only = yes

    trigger = {
        NOT = {
            any_owned_bloodline = {
                has_bloodline_flag = crusader_bloodline
                founder = {
                    character = ROOT
                }
            }
        }
    }

    immediate = {
        sound_effect = bloodline_added
    }

    option = {      
        name = EVTOPTA_HF_49020

        if = {
            limit = {
                is_female = no
            }
            create_bloodline = {
                type = grand_crusader
            }
        }
        if = {
            limit = {
                is_female = yes
            }
            create_bloodline = {
                type = grand_crusader
                inheritance = matrilineal
            }
        }
        set_bloodline_founder_religion_flag_effect = yes
    }
}

# Crusader Commander Bloodline
narrative_event = {
    id = HF.49021
    title = EVTTITLE_HF_49021
    desc = EVTDESC_HF_49021
    picture = GFX_evt_melee
    border = GFX_event_narrative_frame_religion
    is_triggered_only = yes
    has_dlc = "Holy Fury"
    
    trigger = {
        NOT = {
            any_owned_bloodline = {
                has_bloodline_flag = crusader_bloodline
                founder = {
                    character = ROOT
                }
            }
        }
    }

    immediate = {
        event_target:enemy_commander = {
            any_controlled_unit = {
                morale = -1
            }
        }

        sound_effect = bloodline_added
    }

    option = {      
        name = EVTOPTA_HF_49021

        if = {
            limit = {
                event_target:enemy_commander = {
                    ai = yes
                }
            }
            event_target:enemy_commander = {
                death = {
                    death_reason = death_battle
                    killer = ROOT
                }
            }
        }

        if = {
            limit = {
                is_female = no
            }
            create_bloodline = {
                type = crusader_commander
            }
        }
        else_if = {
            limit = {
                is_female = yes
            }
            create_bloodline = {
                type = crusader_commander
                inheritance = matrilineal
            }
        }
        set_bloodline_founder_religion_flag_effect = yes
    }
}